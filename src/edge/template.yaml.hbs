AWSTemplateFormatVersion: "2010-09-09"
Description: "{{description}}"
Resources:

  Certificate:
    Type: "AWS::CertificateManager::Certificate"
    Properties: 
      DomainName: {{{ certificate.verification }}}
      ValidationMethod: DNS
      {{#if certificate.aliases}}
      SubjectAlternativeNames:
        {{#each certificate.aliases}}
        - "{{{ . }}}"
        {{/each}}
      {{/if}}


  Distribution:
    Type: "AWS::CloudFront::Distribution"
    DependsOn:
      - Certificate
    Properties:
      DistributionConfig:
        Aliases:
        {{#each aliases}}
          - '{{{ . }}}'
        {{/each}}
        Comment: {{{ description }}}
        DefaultCacheBehavior:
          TargetOriginId: {{{ origins.[0].domain }}}
          AllowedMethods: [ GET, HEAD, OPTIONS, PUT, PATCH, POST, DELETE ]
          CachedMethods: [ GET, HEAD, OPTIONS ]
          Compress: true
          CachePolicyId: {{{ cache }}}
          {{!-- api-origin-request-policy --}}
          OriginRequestPolicyId: 5cb4eb03-742c-41ae-876b-7f01b1466976
          {{!-- Managed-CORS-with-preflight-and-SecurityHeadersPolicy --}}
          ResponseHeadersPolicyId: eaab4381-ed33-4a86-88ca-d9558dc6cd63
          ViewerProtocolPolicy: redirect-to-https
          {{#if handlers }}
          LambdaFunctionAssociations:
            {{#each handlers}}
            - EventType: {{{ event }}}
              IncludeBody: {{{ includesBody }}}
              LambdaFunctionARN: {{{ arn }}}
            {{/each}}
          {{/if}}

        DefaultRootObject: ""
        Enabled: true
        HttpVersion: http2
        IPV6Enabled: false
        Origins:
          {{#each origins}}
          - Id: {{{ domain }}}
            DomainName: {{{ domain }}}
            {{!-- {{#if s3.private}} --}}
            {{!-- OriginAccessControlId: !Ref OriginAccessControl --}}
            {{!-- Hardcoded for now, since I can't get the above to work --}}
            {{!-- Reference to the 'Sign Requests' OAC --}}
            {{!-- OriginAccessControlId: E28FXZ9WYWK3K7 --}}
            {{!-- 
              Okay, I couldn't get that to work either: I get a 500
              from Cloudformation, so I'm leaving this here to try
              it again later after they hopefully fix whatever's wrong.
            --}}
            {{!-- {{/if}} --}}
            CustomOriginConfig:
              HTTPSPort: 443
              OriginKeepaliveTimeout: 60
              {{#if s3.website}}
              OriginProtocolPolicy: "http-only"
              {{else}}
              OriginProtocolPolicy: "https-only"
              {{/if}}
              OriginReadTimeout: 60
              OriginSSLProtocols: [ "TLSv1.2" ]
            {{#if headers}}
            OriginCustomHeaders:
              {{#each headers}}
              - HeaderName: "{{{ name }}}"
                HeaderValue: >-
                  {{{ value }}}
              {{/each}}
            {{/if}}

          {{/each}}
        PriceClass: PriceClass_100
        ViewerCertificate:
          AcmCertificateArn: !Ref Certificate
          MinimumProtocolVersion: "TLSv1.2_2021"
          SslSupportMethod: "sni-only"
      {{!-- Tags:
        - Key: component
          Value: {{{ namespace }}}
        - Key: environment
          Value: {{{ environment }}} --}}

  {{#if dns}}
  {{#each dns}}
  RecordSet{{{ awsCase tld }}}:
    Type: "AWS::Route53::RecordSetGroup"
    DependsOn:
      - Distribution
    Properties:
      Comment: >-
        {{{ tld }}} alias for 
        {{{ @root.name }}} 
      HostedZoneId: {{{ zone }}}
      RecordSets:
        {{#each aliases}}
        - Name: '{{{ . }}}.'
          Type: A
          AliasTarget:
            DNSName: !GetAtt [ Distribution, "DomainName" ]
            EvaluateTargetHealth: false
            HostedZoneId: Z2FDTNDATAQYW2
        {{/each}}
  {{/each}}
  {{/if}}

Outputs:
  CloudFrontDistributions:
    Value: !Ref Distribution
